#环境列表
'''
# Name                    Version                   Build  Channel
blas                      1.0                         mkl    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
blosc                     1.21.0               h19a0ad4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
brotli                    1.0.9                ha925a31_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
bzip2                     1.0.8                he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
ca-certificates           2021.7.5             haa95532_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
certifi                   2021.5.30        py38haa95532_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
cfitsio                   3.470                he774522_6    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
charls                    2.2.0                h6c2663c_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
cloudpickle               1.6.0                      py_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
cudatoolkit               11.1.1               heb2d755_7    https://mirrors.ustc.edu.cn/anaconda/cloud/conda-forge
cudnn                     8.1.0.77             h3e0f4f4_0    https://mirrors.ustc.edu.cn/anaconda/cloud/conda-forge
cycler                    0.10.0                   py38_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
cytoolz                   0.11.0           py38he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
dask-core                 2021.7.0           pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
freetype                  2.10.4               hd328e21_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
fsspec                    2021.7.0           pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
geos                      3.8.0                h33f27b4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
giflib                    5.2.1                h62dcd97_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
h5py                      2.10.0           py38h5e291fa_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
hdf5                      1.10.4               h7ebc959_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
icc_rt                    2019.0.0             h0cc432a_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
icu                       58.2                 ha925a31_3    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
imagecodecs               2021.6.8         py38h5da4933_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
imageio                   2.9.0              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
imgaug                    0.4.0              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
intel-openmp              2021.3.0          haa95532_3372    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
jpeg                      9b                   hb83a4c4_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
kiwisolver                1.3.1            py38hd77b12b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
lcms2                     2.12                 h83e58a3_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
lerc                      2.2.1                hd77b12b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libaec                    1.0.4                h33f27b4_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libdeflate                1.7                  h2bbff1b_5    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libopencv                 4.0.1                hbb9e17c_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libpng                    1.6.37               h2a8f88b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libprotobuf               3.14.0               h23ce68f_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libsodium                 1.0.18               h62dcd97_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libtiff                   4.2.0                hd0e1b90_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libuv                     1.40.0               he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libzopfli                 1.0.3                ha925a31_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
locket                    0.2.1            py38haa95532_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
lz4-c                     1.9.3                h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
matplotlib                3.3.4            py38haa95532_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
matplotlib-base           3.3.4            py38h49ac443_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl                       2021.3.0           haa95532_524    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl-service               2.4.0            py38h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl_fft                   1.3.0            py38h277e83a_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl_random                1.2.2            py38hf11a4ad_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
networkx                  2.6.1              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
ninja                     1.10.2               h6d14046_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
numpy                     1.20.3           py38ha4e8547_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
numpy-base                1.20.3           py38hc2deb75_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
olefile                   0.46                       py_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
opencv                    4.0.1            py38h2a7c758_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
openjpeg                  2.3.0                h5ec785f_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
openssl                   1.1.1k               h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pandas                    1.2.4            py38hd77b12b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
partd                     1.2.0              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pillow                    8.3.1            py38h4fa10fc_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pip                       21.1.3           py38haa95532_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
protobuf                  3.14.0           py38hd77b12b_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
py-opencv                 4.0.1            py38he44ac1e_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyparsing                 2.4.7              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyqt                      5.9.2            py38ha925a31_4    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyreadline                2.1                      py38_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
python                    3.8.10               hdbf39b2_7    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
python-dateutil           2.8.2              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pytorch                   1.8.1           py3.8_cuda11.1_cudnn8_0    https://mirrors.ustc.edu.cn/anaconda/cloud/pytorch
pytz                      2021.1             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pywavelets                1.1.1            py38he774522_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyyaml                    5.4.1            py38h2bbff1b_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyzmq                     20.0.0           py38hd77b12b_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
qt                        5.9.7            vc14h73c81de_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
scikit-image              0.18.1           py38hf11a4ad_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
scipy                     1.6.2            py38h66253e8_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
setuptools                52.0.0           py38haa95532_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
shapely                   1.7.1            py38h210f175_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
sip                       4.19.13          py38ha925a31_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
six                       1.16.0             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
snappy                    1.1.8                h33f27b4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
sqlite                    3.36.0               h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
tensorboardx              2.2                pyhd8ed1ab_0    https://mirrors.ustc.edu.cn/anaconda/cloud/conda-forge
tifffile                  2021.4.8           pyhd3eb1b0_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
tk                        8.6.10               he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
toolz                     0.11.1             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
torchaudio                0.8.1                      py38    https://mirrors.ustc.edu.cn/anaconda/cloud/pytorch
torchvision               0.9.1                py38_cu111    https://mirrors.ustc.edu.cn/anaconda/cloud/pytorch
tornado                   6.1              py38h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
typing_extensions         3.10.0.0           pyh06a4308_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
vc                        14.2                 h21ff451_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
vs2015_runtime            14.27.29016          h5e58377_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
wheel                     0.36.2             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
wincertstore              0.2                      py38_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
xz                        5.2.5                h62dcd97_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
yaml                      0.2.5                he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
zeromq                    4.3.3                ha925a31_3    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
zfp                       0.5.5                hd77b12b_6    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
zlib                      1.2.11               h62dcd97_4    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
zstd                      1.4.9                h19a0ad4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
'''

#程序说明：一个简单的vgg网络，输入是bs 3 128 128的彩色图片
#第1层卷积输出：bs 3 128 128 with bn and relu
#第2层卷积输出：bs 16 64 64 with bn and relu and pool
#第3层卷积输出：bs 16 64 64 with bn and relu
#第4层卷积输出：bs 32 32 32 with bn and relu and pool
#第5层卷积输出：bs 32 32 32 with bn and relu
#第6层卷积输出：bs 64 16 16 with bn and relu and pool
#第7层卷积输出：bs 64 16 16 with bn and relu
#第8层卷积输出：bs 128 8 8 with bn and relu and pool and dropout
#第9层fc输出：bs 1024
#第10层fc输出：bs 1
#编写人员：刘辉-西安邮电大学
#编写日期：2021.08.06于西安市富力城


# 建议看看这篇文章，了解一下神经网络相关概念，不会问我问老师
# https://ml4a.github.io/ml4a/cn/neural_networks/

import torch
import torch.nn as nn
from torch.nn.modules.activation import Softmax

#模块，里面有两层卷积层，给定输入通道数和输出通道数即可

#什么是类？
# 类就是 一类对象的集合，可以理解为类型，对象就是类的实例化
# 比如 人类: 类， 小明: 对象，工人:人类中的一种，是人类的子类
# 写法: class 关键字加类名，()里加父类
# 一个对象就是一系列数字和函数的集合，相当于C语言的结构体但是加上函数

# 这个类给定输入通道和输出通道即可返回一个两层的卷积网络
class Bottleneck(nn.Module):

    #初始化函数 什么是初始化函数，就是这个类被初始化时调用的函数
    def __init__(self, in_channels, out_channels):
        super().__init__()
        
        # 初始化瓶颈层,建立瓶颈层就是为了减少卷积网络通道的
        self.bottle_neck = nn.Sequential( # 使用Sequential定义顺序模型
            # 使用Conv2d建立卷积层
            nn.Conv2d(in_channels, in_channels, kernel_size=3, bias=True,padding=1),
            # 建立一个归一化层
            nn.BatchNorm2d(in_channels),
            # 激活函数
            nn.ReLU(inplace=True), 
            # 有两层网络 按顺序排列          
            nn.Conv2d(in_channels, out_channels, kernel_size=3, bias=True,padding=1),
            nn.BatchNorm2d(out_channels),#BN
            nn.ReLU(inplace=True),
            nn.MaxPool2d(2,stride=2)
        )

    def forward(self, x):
        return self.bottle_neck(x)

# vgg10 vgg16 实际上是两种 神经网络 的构建方法 如果好奇可深入
# 一文看懂什么是VGG https://zhuanlan.zhihu.com/p/41423739


# 网络的输入图片一定要是128 128画幅的
class vgg10(nn.Module):
    def __init__(self):        
        super().__init__()    

        self.layer_1_2 = Bottleneck( 3,16)  # bs 16 64 64
        self.layer_3_4 = Bottleneck(16,32)  # bs 32 32 32
        self.layer_5_6 = Bottleneck(32,64)  # bs 64 16 16
        self.layer_7_8 = Bottleneck(64,128) # bs 128 8 8
        self.dropout = nn.Dropout(0.5)
        self.layer_9 = nn.Linear(128*8*8, 32)
        self.layer_10 = nn.Linear(32, 2)
        self.softmax = nn.Softmax(dim = 1)

        
    def forward(self, img_128_128):

        out_layer_1_2 = self.layer_1_2(img_128_128)
        out_layer_3_4 = self.layer_3_4(out_layer_1_2)
        out_layer_5_6 = self.layer_5_6(out_layer_3_4)
        out_layer_7_8 = self.layer_7_8(out_layer_5_6)        
        out_view = out_layer_7_8.contiguous().view(out_layer_7_8.shape[0], -1)
        out_dropout = self.dropout(out_view)
        out_layer_9 = self.layer_9(out_dropout)
        out_layer_10 = self.layer_10(out_layer_9)
        out_softmax = self.softmax(out_layer_10)
                
        return out_layer_1_2,out_layer_3_4,out_layer_5_6,out_layer_7_8,out_layer_9,out_layer_10,out_softmax

# 网络的输入图片一定要是128 128画幅的
class vgg16(nn.Module):
    def __init__(self):        
        super().__init__()    

        self.layer_1_2 = Bottleneck( 3,16)  # bs 16 64 64
        self.layer_3_4 = Bottleneck(16,32)  # bs 32 32 32
        self.layer_5_6 = Bottleneck(32,64)  # bs 64 16 16
        self.layer_7_8 = Bottleneck(64,128) # bs 128 8 8
        self.layer_9_10 = Bottleneck(128,128) # bs 128 4 4
        self.layer_11_12 = Bottleneck(128,64) # bs 64 2 2
        self.layer_13_14 = Bottleneck(64,32) # bs 32 1 1
        self.dropout = nn.Dropout(0.5) #增加泛化能力
        self.layer_15 = nn.Linear(32, 128)
        self.layer_16 = nn.Linear(128, 2)
        self.softmax = nn.Softmax(dim = 1)

        
    def forward(self, img_128_128):

        out_layer_1_2 = self.layer_1_2(img_128_128)
        out_layer_3_4 = self.layer_3_4(out_layer_1_2)
        out_layer_5_6 = self.layer_5_6(out_layer_3_4)
        out_layer_7_8 = self.layer_7_8(out_layer_5_6)       
        out_layer_9_10 = self.layer_9_10(out_layer_7_8)  
        out_layer_11_12 = self.layer_11_12(out_layer_9_10)  
        out_layer_13_14 = self.layer_13_14(out_layer_11_12)  
        out_view = out_layer_13_14.contiguous().view(out_layer_13_14.shape[0], -1)
        out_dropout = self.dropout(out_view)
        out_layer_15 = self.layer_15(out_dropout)
        out_layer_16 = self.layer_16(out_layer_15)
        out_softmax = self.softmax(out_layer_16)
                
        return out_layer_1_2,out_layer_3_4,out_layer_5_6,out_layer_7_8,out_layer_9_10,out_layer_11_12,out_layer_13_14,out_layer_15,out_layer_16,out_softmax


# 初始化神经网络权重
def weights_init(m):
    # 如果m是 (nn.Conv2d,nn.Linear) 中的一个子类, 即返回true
    if isinstance(m, (nn.Conv2d,nn.Linear)):
        # nn.init.xavier_uniform_(m.weight,gain=nn.init.calculate_gain('relu'))
        nn.init.uniform_(m.weight,-0.5,0.5)# 使用均匀分布初始化
        # if m.bias is not None:
        #    m.bias.data.zero_()
    # 如果m是 nn.BatchNorm2d 的一个子类
    elif isinstance(m,nn.BatchNorm2d):
        nn.init.uniform_(m.weight,1)
        # 设置偏置单元 https://www.cnblogs.com/shuaishuaidefeizhu/p/6832541.html
        if m.bias is not None:
           m.bias.data.zero_()