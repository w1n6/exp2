#环境列表
'''
# Name                    Version                   Build  Channel
blas                      1.0                         mkl    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
blosc                     1.21.0               h19a0ad4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
brotli                    1.0.9                ha925a31_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
bzip2                     1.0.8                he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
ca-certificates           2021.7.5             haa95532_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
certifi                   2021.5.30        py38haa95532_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
cfitsio                   3.470                he774522_6    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
charls                    2.2.0                h6c2663c_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
cloudpickle               1.6.0                      py_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
cudatoolkit               11.1.1               heb2d755_7    https://mirrors.ustc.edu.cn/anaconda/cloud/conda-forge
cudnn                     8.1.0.77             h3e0f4f4_0    https://mirrors.ustc.edu.cn/anaconda/cloud/conda-forge
cycler                    0.10.0                   py38_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
cytoolz                   0.11.0           py38he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
dask-core                 2021.7.0           pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
freetype                  2.10.4               hd328e21_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
fsspec                    2021.7.0           pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
geos                      3.8.0                h33f27b4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
giflib                    5.2.1                h62dcd97_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
h5py                      2.10.0           py38h5e291fa_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
hdf5                      1.10.4               h7ebc959_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
icc_rt                    2019.0.0             h0cc432a_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
icu                       58.2                 ha925a31_3    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
imagecodecs               2021.6.8         py38h5da4933_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
imageio                   2.9.0              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
imgaug                    0.4.0              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
intel-openmp              2021.3.0          haa95532_3372    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
jpeg                      9b                   hb83a4c4_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
kiwisolver                1.3.1            py38hd77b12b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
lcms2                     2.12                 h83e58a3_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
lerc                      2.2.1                hd77b12b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libaec                    1.0.4                h33f27b4_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libdeflate                1.7                  h2bbff1b_5    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libopencv                 4.0.1                hbb9e17c_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libpng                    1.6.37               h2a8f88b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libprotobuf               3.14.0               h23ce68f_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libsodium                 1.0.18               h62dcd97_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libtiff                   4.2.0                hd0e1b90_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libuv                     1.40.0               he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libzopfli                 1.0.3                ha925a31_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
locket                    0.2.1            py38haa95532_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
lz4-c                     1.9.3                h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
matplotlib                3.3.4            py38haa95532_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
matplotlib-base           3.3.4            py38h49ac443_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl                       2021.3.0           haa95532_524    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl-service               2.4.0            py38h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl_fft                   1.3.0            py38h277e83a_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl_random                1.2.2            py38hf11a4ad_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
networkx                  2.6.1              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
ninja                     1.10.2               h6d14046_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
numpy                     1.20.3           py38ha4e8547_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
numpy-base                1.20.3           py38hc2deb75_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
olefile                   0.46                       py_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
opencv                    4.0.1            py38h2a7c758_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
openjpeg                  2.3.0                h5ec785f_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
openssl                   1.1.1k               h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pandas                    1.2.4            py38hd77b12b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
partd                     1.2.0              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pillow                    8.3.1            py38h4fa10fc_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pip                       21.1.3           py38haa95532_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
protobuf                  3.14.0           py38hd77b12b_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
py-opencv                 4.0.1            py38he44ac1e_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyparsing                 2.4.7              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyqt                      5.9.2            py38ha925a31_4    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyreadline                2.1                      py38_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
python                    3.8.10               hdbf39b2_7    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
python-dateutil           2.8.2              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pytorch                   1.8.1           py3.8_cuda11.1_cudnn8_0    https://mirrors.ustc.edu.cn/anaconda/cloud/pytorch
pytz                      2021.1             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pywavelets                1.1.1            py38he774522_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyyaml                    5.4.1            py38h2bbff1b_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyzmq                     20.0.0           py38hd77b12b_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
qt                        5.9.7            vc14h73c81de_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
scikit-image              0.18.1           py38hf11a4ad_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
scipy                     1.6.2            py38h66253e8_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
setuptools                52.0.0           py38haa95532_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
shapely                   1.7.1            py38h210f175_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
sip                       4.19.13          py38ha925a31_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
six                       1.16.0             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
snappy                    1.1.8                h33f27b4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
sqlite                    3.36.0               h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
tensorboardx              2.2                pyhd8ed1ab_0    https://mirrors.ustc.edu.cn/anaconda/cloud/conda-forge
tifffile                  2021.4.8           pyhd3eb1b0_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
tk                        8.6.10               he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
toolz                     0.11.1             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
torchaudio                0.8.1                      py38    https://mirrors.ustc.edu.cn/anaconda/cloud/pytorch
torchvision               0.9.1                py38_cu111    https://mirrors.ustc.edu.cn/anaconda/cloud/pytorch
tornado                   6.1              py38h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
typing_extensions         3.10.0.0           pyh06a4308_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
vc                        14.2                 h21ff451_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
vs2015_runtime            14.27.29016          h5e58377_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
wheel                     0.36.2             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
wincertstore              0.2                      py38_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
xz                        5.2.5                h62dcd97_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
yaml                      0.2.5                he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
zeromq                    4.3.3                ha925a31_3    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
zfp                       0.5.5                hd77b12b_6    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
zlib                      1.2.11               h62dcd97_4    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
zstd                      1.4.9                h19a0ad4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
'''
#程序说明：模型c测试函数，测试二分类模型

from posixpath import basename
import torch
from net import weights_init
import tools_imgio as imgio
import numpy as np
import os
import cv2 as cv
import json

#函数说明：模型训练程序，训练二分类模型
# 输入数据：
# model：初始化的模型
# img_floder_path：存放待测试图片的文件夹
# check_point_path：checkpoint存放的地址
# cuda = -1：用哪个cuda默认-1即不用cuda
# save_floder_path = 结果文件夹
# 输出数据：
# 无，不需要输出，测试的时候结果直接保存在文件夹里
#编写人员：刘辉-西安邮电大学
#编写日期：2021.08.07于西安市富力城
def test(model,img_floder_path,check_point_path = None,cuda = -1,save_floder_path = None):
    
    # 内部函数,将每一层的输出保存为灰度图片
    # 输入数据：
    # out_layers：网络的每一层输出，注意bs 要为1
    # save_floder_path：保存文件夹路径
    def _save_out_layers(out_layers,save_floder_path):
        
        #把数据转换成numpy
        out_layers = out_layers.cpu().data.numpy().astype(np.uint8)

        #循环保存数据        
        for i in range(out_layers.shape[1]):
            layer_img = out_layers[0,i,:,:]
            range_lay_img = np.max(layer_img) - np.min(layer_img)
            if np.abs(range_lay_img) < 0.0001:
                range_lay_img = range_lay_img + 0.01
            layer_img = np.clip(255*((layer_img - np.min(layer_img)) / range_lay_img),0,255).astype(np.uint8)
            cv.imwrite(save_floder_path + '%08d.jpg'%i,cv.resize(layer_img,(128,128)))


    #创建存放标志为1的图片的文件夹
    save_floder_path_1 = save_floder_path + '1/'
    if not os.path.exists(save_floder_path_1):
        os.makedirs(save_floder_path_1) #如果结果文件夹还没创建，就创建一下
    #创建存放标志为0的图片的文件夹
    save_floder_path_0 = save_floder_path + '0/'
    if not os.path.exists(save_floder_path_0):
        os.makedirs(save_floder_path_0) #如果结果文件夹还没创建，就创建一下
   
    #获取测试图片地址
    test_img_paths = imgio.get_img_paths(img_floder_path)
    #获取测试图片的basename
    base_names = imgio.get_base_names(test_img_paths)
    
    #加载模型参数
    if check_point_path is not None:
        print("loading model...")    
        checkpoint = torch.load(check_point_path)   
        model.load_state_dict(checkpoint['model']) #加载训练好的参数     
    
    #把模型放进gpu里
    if cuda >= 0 and torch.cuda.is_available():
        model.cuda(cuda)

    #开始测试
    model.eval()
    print('start testing...')
    feature_vecs = {}
    for test_img_path,base_name in zip(test_img_paths,base_names):
        
        #创建保存过程记录图片的文件夹
        save_floder_path_log = save_floder_path + base_name + '/'
        if not os.path.exists(save_floder_path_log):
            os.makedirs(save_floder_path_log) #如果结果文件夹还没创建，就创建一下
        
        #记录第2层输出结果 64 64
        save_floder_path_layer_2 = save_floder_path_log + 'layer_2/'
        if not os.path.exists(save_floder_path_layer_2):
            os.makedirs(save_floder_path_layer_2) #如果结果文件夹还没创建，就创建一下
        
        #记录第4层输出结果 32 32
        save_floder_path_layer_4 = save_floder_path_log + 'layer_4/'
        if not os.path.exists(save_floder_path_layer_4):
            os.makedirs(save_floder_path_layer_4) #如果结果文件夹还没创建，就创建一下
        
        #记录第6层输出结果 16 16
        save_floder_path_layer_6 = save_floder_path_log + 'layer_6/'
        if not os.path.exists(save_floder_path_layer_6):
            os.makedirs(save_floder_path_layer_6) #如果结果文件夹还没创建，就创建一下
        
        #记录第8层输出结果 8 8
        save_floder_path_layer_8 = save_floder_path_log + 'layer_8/'
        if not os.path.exists(save_floder_path_layer_8):
            os.makedirs(save_floder_path_layer_8) #如果结果文件夹还没创建，就创建一下
        
        #记录第10层输出结果 4 4
        save_floder_path_layer_10 = save_floder_path_log + 'layer_10/'
        if not os.path.exists(save_floder_path_layer_10):
            os.makedirs(save_floder_path_layer_10) #如果结果文件夹还没创建，就创建一下

        #记录第12层输出结果 2 2
        save_floder_path_layer_12 = save_floder_path_log + 'layer_12/'
        if not os.path.exists(save_floder_path_layer_12):
            os.makedirs(save_floder_path_layer_12) #如果结果文件夹还没创建，就创建一下
        
        #读取图片数据
        test_img = imgio.get_imgs_RGB([test_img_path])

        #将图片打包成1 3 128 128的形式，并放入torch里
        test_x_T = torch.from_numpy((test_img/255).swapaxes(1,3).swapaxes(2,3)).to(torch.float32)
                              
        #把数据放进gpu里
        if cuda >= 0 and torch.cuda.is_available():
            test_x_T = test_x_T.cuda(cuda)
            
        #求模型输出
        out_layer_1_2,out_layer_3_4,out_layer_5_6,out_layer_7_8,out_layer_9_10,out_layer_11_12,out_layer_13_14,out_layer_15,out_layer_16,out = model(test_x_T)

        #保存每一层的输出结果
        _save_out_layers(out_layer_1_2,save_floder_path_layer_2)
        _save_out_layers(out_layer_3_4,save_floder_path_layer_4)
        _save_out_layers(out_layer_5_6,save_floder_path_layer_6)
        _save_out_layers(out_layer_7_8,save_floder_path_layer_8)
        _save_out_layers(out_layer_9_10,save_floder_path_layer_10)
        _save_out_layers(out_layer_11_12,save_floder_path_layer_12)

        #feature_vecs中保存每一张图片的特征向量
        feature_vec = out_layer_13_14.cpu().data.numpy().reshape(-1)
        feature_vec = ['%.1f'%f_v for f_v in feature_vec]
        feature_vec = ','.join(feature_vec)        
        feature_vecs[base_name] = feature_vec

        #根据分类结果保存图片
        if out.cpu().data.numpy()[0,0] > 0.5:
            cv.imwrite(save_floder_path_1 + base_name + '.jpg',cv.cvtColor(test_img[0],cv.COLOR_RGB2BGR))
        else:
            cv.imwrite(save_floder_path_0 + base_name + '.jpg',cv.cvtColor(test_img[0],cv.COLOR_RGB2BGR))
    
    #保存特征向量
    with open(save_floder_path + 'feature_vec.txt','w') as f:
        f.write(json.dumps( feature_vecs,ensure_ascii=True,sort_keys = True,indent=2,separators=(',',':') ))
    print("Done")



    

        
    
