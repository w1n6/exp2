#环境列表
'''
# Name                    Version                   Build  Channel
blas                      1.0                         mkl    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
blosc                     1.21.0               h19a0ad4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
brotli                    1.0.9                ha925a31_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
bzip2                     1.0.8                he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
ca-certificates           2021.7.5             haa95532_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
certifi                   2021.5.30        py38haa95532_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
cfitsio                   3.470                he774522_6    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
charls                    2.2.0                h6c2663c_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
cloudpickle               1.6.0                      py_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
cudatoolkit               11.1.1               heb2d755_7    https://mirrors.ustc.edu.cn/anaconda/cloud/conda-forge
cudnn                     8.1.0.77             h3e0f4f4_0    https://mirrors.ustc.edu.cn/anaconda/cloud/conda-forge
cycler                    0.10.0                   py38_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
cytoolz                   0.11.0           py38he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
dask-core                 2021.7.0           pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
freetype                  2.10.4               hd328e21_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
fsspec                    2021.7.0           pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
geos                      3.8.0                h33f27b4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
giflib                    5.2.1                h62dcd97_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
h5py                      2.10.0           py38h5e291fa_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
hdf5                      1.10.4               h7ebc959_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
icc_rt                    2019.0.0             h0cc432a_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
icu                       58.2                 ha925a31_3    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
imagecodecs               2021.6.8         py38h5da4933_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
imageio                   2.9.0              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
imgaug                    0.4.0              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
intel-openmp              2021.3.0          haa95532_3372    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
jpeg                      9b                   hb83a4c4_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
kiwisolver                1.3.1            py38hd77b12b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
lcms2                     2.12                 h83e58a3_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
lerc                      2.2.1                hd77b12b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libaec                    1.0.4                h33f27b4_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libdeflate                1.7                  h2bbff1b_5    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libopencv                 4.0.1                hbb9e17c_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libpng                    1.6.37               h2a8f88b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libprotobuf               3.14.0               h23ce68f_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libsodium                 1.0.18               h62dcd97_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libtiff                   4.2.0                hd0e1b90_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libuv                     1.40.0               he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libzopfli                 1.0.3                ha925a31_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
locket                    0.2.1            py38haa95532_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
lz4-c                     1.9.3                h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
matplotlib                3.3.4            py38haa95532_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
matplotlib-base           3.3.4            py38h49ac443_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl                       2021.3.0           haa95532_524    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl-service               2.4.0            py38h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl_fft                   1.3.0            py38h277e83a_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl_random                1.2.2            py38hf11a4ad_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
networkx                  2.6.1              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
ninja                     1.10.2               h6d14046_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
numpy                     1.20.3           py38ha4e8547_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
numpy-base                1.20.3           py38hc2deb75_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
olefile                   0.46                       py_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
opencv                    4.0.1            py38h2a7c758_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
openjpeg                  2.3.0                h5ec785f_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
openssl                   1.1.1k               h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pandas                    1.2.4            py38hd77b12b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
partd                     1.2.0              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pillow                    8.3.1            py38h4fa10fc_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pip                       21.1.3           py38haa95532_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
protobuf                  3.14.0           py38hd77b12b_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
py-opencv                 4.0.1            py38he44ac1e_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyparsing                 2.4.7              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyqt                      5.9.2            py38ha925a31_4    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyreadline                2.1                      py38_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
python                    3.8.10               hdbf39b2_7    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
python-dateutil           2.8.2              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pytorch                   1.8.1           py3.8_cuda11.1_cudnn8_0    https://mirrors.ustc.edu.cn/anaconda/cloud/pytorch
pytz                      2021.1             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pywavelets                1.1.1            py38he774522_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyyaml                    5.4.1            py38h2bbff1b_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyzmq                     20.0.0           py38hd77b12b_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
qt                        5.9.7            vc14h73c81de_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
scikit-image              0.18.1           py38hf11a4ad_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
scipy                     1.6.2            py38h66253e8_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
setuptools                52.0.0           py38haa95532_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
shapely                   1.7.1            py38h210f175_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
sip                       4.19.13          py38ha925a31_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
six                       1.16.0             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
snappy                    1.1.8                h33f27b4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
sqlite                    3.36.0               h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
tensorboardx              2.2                pyhd8ed1ab_0    https://mirrors.ustc.edu.cn/anaconda/cloud/conda-forge
tifffile                  2021.4.8           pyhd3eb1b0_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
tk                        8.6.10               he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
toolz                     0.11.1             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
torchaudio                0.8.1                      py38    https://mirrors.ustc.edu.cn/anaconda/cloud/pytorch
torchvision               0.9.1                py38_cu111    https://mirrors.ustc.edu.cn/anaconda/cloud/pytorch
tornado                   6.1              py38h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
typing_extensions         3.10.0.0           pyh06a4308_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
vc                        14.2                 h21ff451_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
vs2015_runtime            14.27.29016          h5e58377_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
wheel                     0.36.2             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
wincertstore              0.2                      py38_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
xz                        5.2.5                h62dcd97_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
yaml                      0.2.5                he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
zeromq                    4.3.3                ha925a31_3    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
zfp                       0.5.5                hd77b12b_6    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
zlib                      1.2.11               h62dcd97_4    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
zstd                      1.4.9                h19a0ad4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
'''

#程序说明：通过图片三个通道的色彩均方差，计算两张图片的相似度
#编写人员：刘辉-西安邮电大学
#编写日期：2021.08.06于西安市富力城
#训练：python main.py -mode train
#测试：python main.py -mode test
#可视化：python main.py -mode vision
#注意：执行完可视化命令后，在终端输入指令tensorboard --logdir=runs 查看可视化结果，指令输入后会得到一个地址，如下：
#TensorBoard 2.5.0 at http://localhost:6006/ (Press CTRL+C to quit)
#把地址放到浏览器里就可以查看模型了


from typing_extensions import ParamSpecKwargs
import cv2 as cv
import numpy as np
import glob
import os
import argparse
import torch
import tools_imgio as imgio
import tools_simple_cal as s_cal
from net import vgg16
from train import train
from test import test
from model_graph import model_graph

train_data_path = '../data/train/'
test_data_path = '../data/test/'
val_data_path = '../data/val/'
result_path = '../result/loss_0.01692/'
model_save_path = '../model_save3/'
check_point_path = '../model_save3/net_params-epoch_00000039-loss_0.01692.pkl'
# check_point_path = None

#根据调用的命令参数，调用train还是test
if __name__ == '__main__':

    #判断是train还是test
    parser = argparse.ArgumentParser()
    parser.add_argument('-mode', action='store', dest='mode', type=str,
                        help='train or test ', required =False, default="test")
    args = parser.parse_args()

    if not os.path.exists(result_path):
        os.makedirs(result_path) #如果结果文件夹还没创建，就创建一下
    if not os.path.exists(model_save_path):
        os.makedirs(model_save_path) #如果结果文件夹还没创建，就创建一下

    #加载模型
    model = vgg16()
    
    #训练或测试
    if args.mode == "train":
        model = train(model,[train_data_path + '/1/',val_data_path + '/1/'],
                            [train_data_path + '/0/',val_data_path + '/0/'],check_point_path,cuda = 0,lr = 0.01,save_floder_path = model_save_path)        
    elif args.mode == "test":
        test(model,test_data_path,check_point_path,cuda = 0,save_floder_path = result_path)
    else:
        model_graph(model,test_data_path,check_point_path,cuda = 0)
