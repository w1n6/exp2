#环境列表
'''
# Name                    Version                   Build  Channel
blas                      1.0                         mkl    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
blosc                     1.21.0               h19a0ad4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
brotli                    1.0.9                ha925a31_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
bzip2                     1.0.8                he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
ca-certificates           2021.7.5             haa95532_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
certifi                   2021.5.30        py38haa95532_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
cfitsio                   3.470                he774522_6    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
charls                    2.2.0                h6c2663c_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
cloudpickle               1.6.0                      py_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main        
cudatoolkit               11.1.1               heb2d755_7    https://mirrors.ustc.edu.cn/anaconda/cloud/conda-forge
cudnn                     8.1.0.77             h3e0f4f4_0    https://mirrors.ustc.edu.cn/anaconda/cloud/conda-forge
cycler                    0.10.0                   py38_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
cytoolz                   0.11.0           py38he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
dask-core                 2021.7.0           pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
freetype                  2.10.4               hd328e21_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
fsspec                    2021.7.0           pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
geos                      3.8.0                h33f27b4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
giflib                    5.2.1                h62dcd97_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
h5py                      2.10.0           py38h5e291fa_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
hdf5                      1.10.4               h7ebc959_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
icc_rt                    2019.0.0             h0cc432a_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
icu                       58.2                 ha925a31_3    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
imagecodecs               2021.6.8         py38h5da4933_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
imageio                   2.9.0              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
imgaug                    0.4.0              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
intel-openmp              2021.3.0          haa95532_3372    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
jpeg                      9b                   hb83a4c4_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
kiwisolver                1.3.1            py38hd77b12b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
lcms2                     2.12                 h83e58a3_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
lerc                      2.2.1                hd77b12b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libaec                    1.0.4                h33f27b4_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libdeflate                1.7                  h2bbff1b_5    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libopencv                 4.0.1                hbb9e17c_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libpng                    1.6.37               h2a8f88b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libprotobuf               3.14.0               h23ce68f_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libsodium                 1.0.18               h62dcd97_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libtiff                   4.2.0                hd0e1b90_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libuv                     1.40.0               he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libzopfli                 1.0.3                ha925a31_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
locket                    0.2.1            py38haa95532_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
lz4-c                     1.9.3                h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
matplotlib                3.3.4            py38haa95532_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
matplotlib-base           3.3.4            py38h49ac443_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl                       2021.3.0           haa95532_524    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl-service               2.4.0            py38h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl_fft                   1.3.0            py38h277e83a_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl_random                1.2.2            py38hf11a4ad_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
networkx                  2.6.1              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
ninja                     1.10.2               h6d14046_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
numpy                     1.20.3           py38ha4e8547_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
numpy-base                1.20.3           py38hc2deb75_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
olefile                   0.46                       py_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
opencv                    4.0.1            py38h2a7c758_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
openjpeg                  2.3.0                h5ec785f_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
openssl                   1.1.1k               h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pandas                    1.2.4            py38hd77b12b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
partd                     1.2.0              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pillow                    8.3.1            py38h4fa10fc_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pip                       21.1.3           py38haa95532_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
protobuf                  3.14.0           py38hd77b12b_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
py-opencv                 4.0.1            py38he44ac1e_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyparsing                 2.4.7              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyqt                      5.9.2            py38ha925a31_4    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyreadline                2.1                      py38_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
python                    3.8.10               hdbf39b2_7    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
python-dateutil           2.8.2              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pytorch                   1.8.1           py3.8_cuda11.1_cudnn8_0    https://mirrors.ustc.edu.cn/anaconda/cloud/pytorch
pytz                      2021.1             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pywavelets                1.1.1            py38he774522_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyyaml                    5.4.1            py38h2bbff1b_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyzmq                     20.0.0           py38hd77b12b_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
qt                        5.9.7            vc14h73c81de_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
scikit-image              0.18.1           py38hf11a4ad_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
scipy                     1.6.2            py38h66253e8_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
setuptools                52.0.0           py38haa95532_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
shapely                   1.7.1            py38h210f175_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
sip                       4.19.13          py38ha925a31_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
six                       1.16.0             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
snappy                    1.1.8                h33f27b4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
sqlite                    3.36.0               h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
tensorboardx              2.2                pyhd8ed1ab_0    https://mirrors.ustc.edu.cn/anaconda/cloud/conda-forge
tifffile                  2021.4.8           pyhd3eb1b0_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
tk                        8.6.10               he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
toolz                     0.11.1             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
torchaudio                0.8.1                      py38    https://mirrors.ustc.edu.cn/anaconda/cloud/pytorch
torchvision               0.9.1                py38_cu111    https://mirrors.ustc.edu.cn/anaconda/cloud/pytorch
tornado                   6.1              py38h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
typing_extensions         3.10.0.0           pyh06a4308_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
vc                        14.2                 h21ff451_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
vs2015_runtime            14.27.29016          h5e58377_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
wheel                     0.36.2             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
wincertstore              0.2                      py38_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
xz                        5.2.5                h62dcd97_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
yaml                      0.2.5                he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
zeromq                    4.3.3                ha925a31_3    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
zfp                       0.5.5                hd77b12b_6    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
zlib                      1.2.11               h62dcd97_4    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
zstd                      1.4.9                h19a0ad4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
'''
#程序说明：模型训练函数，训练二分类模型

import torch
from net import weights_init
import tools_imgio as imgio
import numpy as np

#函数说明：模型训练程序，训练二分类模型
# 输入数据：
# model：待训练的模型
# img_1_floder_path：标记为真，即包含识别物体的图片存放的文件夹 [0]为train [1]为val
# img_0_floder_path：标记为真，即不包含识别物体的图片存放的文件夹 [0]为train [1]为val
# check_point_path：checkpoint存放的地址
# cuda = -1：用哪个cuda默认-1即不用cuda
# lr = 0.001：初始学习率
# save_floder_path = checkpoint保存文件夹路径
# 输出数据：
# 训练好的模型，不过一般不需要输出，模型会保存在路径里，测试的时候直接调用路径就行
#编写人员：刘辉-西安邮电大学
#编写日期：2021.08.06于西安市富力城
def train(model,img_1_floder_path,img_0_floder_path,check_point_path = None,cuda = -1,lr = 0.001,save_floder_path = None):
       
    #获取训练用的图片
    train_img_1_paths = imgio.get_img_paths(img_1_floder_path[0])
    train_img_0_paths = imgio.get_img_paths(img_0_floder_path[0])
    #获取验证用的图片
    val_img_1_paths = imgio.get_img_paths(img_1_floder_path[1])
    val_img_0_paths = imgio.get_img_paths(img_0_floder_path[1])   

    #如果有原来训练的断点，就拿出来继续训练
    if check_point_path is not None:
        print("loading model...")    
        checkpoint = torch.load(check_point_path)   
        model.load_state_dict(checkpoint['model']) #加载训练好的参数        
    else:
        model.apply(weights_init)#没有就重新训练模型
    
    #把模型放进gpu里
    if cuda >= 0 and torch.cuda.is_available():
        model.cuda(cuda)

    #创建优化器
    optimizer = torch.optim.SGD(model.parameters(), lr=lr)
    #创建训练策略
    step_schedule = torch.optim.lr_scheduler.StepLR(step_size=20, gamma=0.5, optimizer=optimizer)
    epoch = 0
    #创建损失函数
    loss_func = torch.nn.CrossEntropyLoss()
    
    #如果优化器有checkpoint，加载
    if check_point_path is not None:
        optimizer.load_state_dict(checkpoint['optimizer'])
        step_schedule.load_state_dict(checkpoint['schedule'])        
        epoch = checkpoint['epoch']
            
    
    #采用随机抽样的方式，每次训练，随机从1和0文件夹中读取一张图片，组成一对图片进行训练
    num_train_img_1 = len(train_img_1_paths)#获取train中标志位1的图片的数量
    num_train_img_0 = len(train_img_0_paths)#获取train中标志位0的图片的数量
    max_cont_in_epoch = max(num_train_img_0,num_train_img_1)*2 #每个epoch中，训练的数据对数

    # 开始训练
    print('start training...')
    while epoch < 30000:

        #开始一个新的epoch训练
        cont_in_epoch = 0
        model.train()
        while cont_in_epoch < max_cont_in_epoch:
            
            #一次读取一对标志位1和0的图片
            index_train_img_1 = np.random.randint(0,num_train_img_1)
            index_train_img_0 = np.random.randint(0,num_train_img_0)
            train_img_1 = imgio.get_imgs_RGB([train_img_1_paths[index_train_img_1]])
            train_img_0 = imgio.get_imgs_RGB([train_img_0_paths[index_train_img_0]])
            
            #将图片打包成2 3 128 128的形式，并放入torch里
            train_x = np.concatenate((train_img_1,train_img_0),axis = 0)
            train_x_T = torch.from_numpy((train_x/255).swapaxes(1,3).swapaxes(2,3)).to(torch.float32)
            
            #生成标签数据，形式2 1，并放入torch里
            train_y = np.array([0,1])
            train_y_T = torch.from_numpy(train_y).to(torch.long)
            
            #把数据放进gpu里
            if cuda >= 0 and torch.cuda.is_available():
                train_x_T = train_x_T.cuda(cuda)
                train_y_T = train_y_T.cuda(cuda)
            
            #求模型输出
            _,_,_,_,_,_,_,_,out,_ = model(train_x_T)

            #计算损失            
            loss = loss_func(out,train_y_T)      
            loss_print = np.mean(loss.cpu().data.numpy()) #后续用于显示
            
            #优化
            optimizer.zero_grad()               
            loss.backward()               
            optimizer.step()

            #打印当前训练结果
            lr_print = optimizer.state_dict()['param_groups'][0]['lr']
            print('epoch:%08d'%epoch + \
                  '[%08d'%cont_in_epoch + ' of %08d]' % max_cont_in_epoch + \
                  '|loss:%f'%loss_print + '|lr_rate:%f' % lr_print)

            #计数加1                
            cont_in_epoch = cont_in_epoch + 1
        
        #每个epoch结束后，进行验证，并保存模型
        model.eval()
        val_loss_sum = 0
        cont_val_loss_sum = 0
        #计算验证集的平均loss,先计算标志位1的数据
        for val_img_1_path in val_img_1_paths:

            #一次读取一张标志为1的图片    
            val_img_1 = imgio.get_imgs_RGB([val_img_1_path])
            
            #将图片打包成1 3 128 128的形式，并放入torch里
            val_x_T = torch.from_numpy((val_img_1/255).swapaxes(1,3).swapaxes(2,3)).to(torch.float32)
            
            #生成标签数据，形式1 2，并放入torch里
            val_y = np.array([[1,0]],dtype=np.float32)  
            
            #把数据放进gpu里
            if cuda >= 0 and torch.cuda.is_available():
                val_x_T = val_x_T.cuda(cuda)
            
            #求模型输出
            _,_,_,_,_,_,_,_,_,out = model(val_x_T)

            #计算损失
            loss = np.mean(np.abs(out.cpu().data.numpy() - val_y))
            val_loss_sum = val_loss_sum + loss
            cont_val_loss_sum = cont_val_loss_sum + 1
        
        #计算验证集的平均loss,再计算标志位0的数据
        for val_img_0_path in val_img_0_paths:

            #一次读取一张标志为1的图片    
            val_img_0 = imgio.get_imgs_RGB([val_img_0_path])
            
            #将图片打包成1 3 128 128的形式，并放入torch里
            val_x_T = torch.from_numpy((val_img_0/255).swapaxes(1,3).swapaxes(2,3)).to(torch.float32)
            
            #生成标签数据，形式1 2，并放入torch里
            val_y = np.array([[0,1]],dtype=np.float32)  
            
            #把数据放进gpu里
            if cuda >= 0 and torch.cuda.is_available():
                val_x_T = val_x_T.cuda(cuda)
            
            #求模型输出
            _,_,_,_,_,_,_,_,_,out = model(val_x_T)

            #计算损失
            loss = np.mean(np.abs(out.cpu().data.numpy() - val_y))
            val_loss_sum = val_loss_sum + loss
            cont_val_loss_sum = cont_val_loss_sum + 1
        #保存模型
        val_loss_mean = val_loss_sum/cont_val_loss_sum
        state_net_opt = {'model': model.state_dict(), 'optimizer': optimizer.state_dict(), 'schedule':step_schedule.state_dict(), 'epoch': epoch}     
        torch.save(state_net_opt, save_floder_path + "net_params-epoch_%08d"% (epoch) +"-loss_%.5f"%val_loss_mean + ".pkl" ) 
        print('save_net')

        #更新学习率
        step_schedule.step()
        #计数加1
        epoch = epoch + 1
        
    print("Done")
    return model

            









    

        
    