#环境列表
'''
# Name                    Version                   Build  Channel
# Name                    Version                   Build  Channel
absl-py                   0.13.0             pyhd8ed1ab_0    conda-forge
aiohttp                   3.7.4.post0      py38h294d835_0    conda-forge
async-timeout             3.0.1                   py_1000    conda-forge
attrs                     21.2.0             pyhd8ed1ab_0    conda-forge
blas                      1.0                         mkl    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
blinker                   1.4                        py_1    conda-forge
blosc                     1.21.0               h19a0ad4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
brotli                    1.0.9                ha925a31_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
brotlipy                  0.7.0           py38h294d835_1001    conda-forge
bzip2                     1.0.8                he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
ca-certificates           2021.5.30            h5b45459_0    conda-forge
cachetools                4.2.2              pyhd8ed1ab_0    conda-forge
certifi                   2021.5.30        py38haa244fe_0    conda-forge
cffi                      1.14.6           py38hd8c33c5_0    conda-forge
cfitsio                   3.470                he774522_6    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
chardet                   4.0.0            py38haa244fe_1    conda-forge
charls                    2.2.0                h6c2663c_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
charset-normalizer        2.0.4                    pypi_0    pypi
click                     8.0.1            py38haa244fe_0    conda-forge
cloudpickle               1.6.0                      py_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
colorama                  0.4.4              pyh9f0ad1d_0    conda-forge
cryptography              3.4.7            py38hd7da0ea_0    conda-forge
cudatoolkit               11.1.1               heb2d755_7    https://mirrors.ustc.edu.cn/anaconda/cloud/conda-forge
cudnn                     8.1.0.77             h3e0f4f4_0    https://mirrors.ustc.edu.cn/anaconda/cloud/conda-forge
cycler                    0.10.0                   py38_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
cytoolz                   0.11.0           py38he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
dask-core                 2021.7.0           pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
dataclasses               0.8                pyhc8e2a94_1    conda-forge
freetype                  2.10.4               hd328e21_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
fsspec                    2021.7.0           pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
geos                      3.8.0                h33f27b4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
giflib                    5.2.1                h62dcd97_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
google-auth               1.34.0             pyh6c4a22f_0    conda-forge
google-auth-oauthlib      0.4.5                    pypi_0    pypi
grpcio                    1.39.0                   pypi_0    pypi
h5py                      2.10.0           py38h5e291fa_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
hdf5                      1.10.4               h7ebc959_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
icc_rt                    2019.0.0             h0cc432a_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
icu                       58.2                 ha925a31_3    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
idna                      3.2                      pypi_0    pypi
imagecodecs               2021.6.8         py38h5da4933_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
imageio                   2.9.0              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
imgaug                    0.4.0              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
importlib-metadata        4.6.3            py38haa244fe_0    conda-forge
intel-openmp              2021.3.0          haa95532_3372    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
jpeg                      9b                   hb83a4c4_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
kiwisolver                1.3.1            py38hd77b12b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
lcms2                     2.12                 h83e58a3_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
lerc                      2.2.1                hd77b12b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libaec                    1.0.4                h33f27b4_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libdeflate                1.7                  h2bbff1b_5    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libopencv                 4.0.1                hbb9e17c_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libpng                    1.6.37               h2a8f88b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libprotobuf               3.14.0               h23ce68f_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libsodium                 1.0.18               h62dcd97_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libtiff                   4.2.0                hd0e1b90_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libuv                     1.40.0               he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
libzopfli                 1.0.3                ha925a31_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
locket                    0.2.1            py38haa95532_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
lz4-c                     1.9.3                h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
markdown                  3.3.4              pyhd8ed1ab_0    conda-forge
matplotlib                3.3.4            py38haa95532_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
matplotlib-base           3.3.4            py38h49ac443_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl                       2021.3.0           haa95532_524    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl-service               2.4.0            py38h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl_fft                   1.3.0            py38h277e83a_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
mkl_random                1.2.2            py38hf11a4ad_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
multidict                 5.1.0            py38h294d835_1    conda-forge
networkx                  2.6.1              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
ninja                     1.10.2               h6d14046_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
numpy                     1.20.3           py38ha4e8547_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
numpy-base                1.20.3           py38hc2deb75_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
oauthlib                  3.1.1              pyhd8ed1ab_0    conda-forge
olefile                   0.46                       py_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
opencv                    4.0.1            py38h2a7c758_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
openjpeg                  2.3.0                h5ec785f_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
openssl                   1.1.1k               h8ffe710_0    conda-forge
pandas                    1.2.4            py38hd77b12b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
partd                     1.2.0              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pillow                    8.3.1            py38h4fa10fc_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pip                       21.1.3           py38haa95532_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
protobuf                  3.14.0           py38hd77b12b_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
py-opencv                 4.0.1            py38he44ac1e_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyasn1                    0.4.8                      py_0    conda-forge
pyasn1-modules            0.2.8                    pypi_0    pypi
pycparser                 2.20               pyh9f0ad1d_2    conda-forge
pyjwt                     2.1.0              pyhd8ed1ab_0    conda-forge
pyopenssl                 20.0.1             pyhd8ed1ab_0    conda-forge
pyparsing                 2.4.7              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyqt                      5.9.2            py38ha925a31_4    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyreadline                2.1                      py38_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pysocks                   1.7.1            py38haa244fe_3    conda-forge
python                    3.8.10               hdbf39b2_7    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
python-dateutil           2.8.2              pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
python_abi                3.8                      2_cp38    conda-forge
pytorch                   1.8.1           py3.8_cuda11.1_cudnn8_0    https://mirrors.ustc.edu.cn/anaconda/cloud/pytorch
pytz                      2021.1             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyu2f                     0.1.5              pyhd8ed1ab_0    conda-forge
pywavelets                1.1.1            py38he774522_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyyaml                    5.4.1            py38h2bbff1b_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
pyzmq                     20.0.0           py38hd77b12b_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
qt                        5.9.7            vc14h73c81de_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
requests                  2.26.0             pyhd8ed1ab_0    conda-forge
requests-oauthlib         1.3.0              pyh9f0ad1d_0    conda-forge
rsa                       4.7.2              pyh44b312d_0    conda-forge
scikit-image              0.18.1           py38hf11a4ad_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
scipy                     1.6.2            py38h66253e8_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
setuptools                52.0.0           py38haa95532_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
shapely                   1.7.1            py38h210f175_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
sip                       4.19.13          py38ha925a31_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
six                       1.16.0             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
snappy                    1.1.8                h33f27b4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
sqlite                    3.36.0               h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
tensorboard               2.6.0                    pypi_0    pypi
tensorboard-data-server   0.6.1                    pypi_0    pypi
tensorboard-plugin-wit    1.8.0              pyh44b312d_0    conda-forge
tensorboardx              2.2                pyhd8ed1ab_0    https://mirrors.ustc.edu.cn/anaconda/cloud/conda-forge
tifffile                  2021.4.8           pyhd3eb1b0_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
tk                        8.6.10               he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
toolz                     0.11.1             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
torch-tb-profiler         0.2.1                    pypi_0    pypi
torchaudio                0.8.1                      py38    https://mirrors.ustc.edu.cn/anaconda/cloud/pytorch
torchvision               0.9.1                py38_cu111    https://mirrors.ustc.edu.cn/anaconda/cloud/pytorch
tornado                   6.1              py38h2bbff1b_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
typing-extensions         3.10.0.0             hd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
typing_extensions         3.10.0.0           pyh06a4308_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
urllib3                   1.26.6             pyhd8ed1ab_0    conda-forge
vc                        14.2                 h21ff451_1    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
vs2015_runtime            14.27.29016          h5e58377_2    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
werkzeug                  2.0.1              pyhd8ed1ab_0    conda-forge
wheel                     0.36.2             pyhd3eb1b0_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
win_inet_pton             1.1.0            py38haa244fe_2    conda-forge
wincertstore              0.2                      py38_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
xz                        5.2.5                h62dcd97_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
yaml                      0.2.5                he774522_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
yarl                      1.6.3            py38h294d835_2    conda-forge
zeromq                    4.3.3                ha925a31_3    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
zfp                       0.5.5                hd77b12b_6    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
zipp                      3.5.0              pyhd8ed1ab_0    conda-forge
zlib                      1.2.11               h62dcd97_4    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
zstd                      1.4.9                h19a0ad4_0    https://mirrors.ustc.edu.cn/anaconda/pkgs/main
'''
#程序说明：模型可视化

from posixpath import basename
import torch
from net import weights_init
import tools_imgio as imgio
import numpy as np
import os
import cv2 as cv
import json


from tensorboardX import SummaryWriter
writer = SummaryWriter('../log') #建立一个保存数据用的东西

#函数说明：模型训练程序，训练二分类模型
# 输入数据：
# model：初始化的模型
# img_floder_path：存放待测试图片的文件夹
# check_point_path：checkpoint存放的地址
# cuda = -1：用哪个cuda默认-1即不用cuda
# save_floder_path = 结果文件夹
# 输出数据：
# 无，不需要输出，测试的时候结果直接保存在文件夹里
#编写人员：刘辉-西安邮电大学
#编写日期：2021.08.07于西安市富力城
def model_graph(model,img_floder_path,check_point_path = None,cuda = -1):
          
    #获取测试图片地址
    test_img_paths = imgio.get_img_paths(img_floder_path)
    #获取测试图片的basename
    base_names = imgio.get_base_names(test_img_paths)
    
    #加载模型参数
    if check_point_path is not None:
        print("loading model...")    
        checkpoint = torch.load(check_point_path)   
        model.load_state_dict(checkpoint['model']) #加载训练好的参数     
    
    #把模型放进gpu里
    if cuda >= 0 and torch.cuda.is_available():
        model.cuda(cuda)

                
    #读取图片数据
    test_img = imgio.get_imgs_RGB([test_img_paths[0]])

    #将图片打包成1 3 128 128的形式，并放入torch里
    test_x_T = torch.from_numpy((test_img/255).swapaxes(1,3).swapaxes(2,3)).to(torch.float32)
                            
    #把数据放进gpu里
    if cuda >= 0 and torch.cuda.is_available():
        test_x_T = test_x_T.cuda(cuda)
        
    #可视化输出
    with SummaryWriter(comment='LeNet') as w:
        w.add_graph(model, (test_x_T,))    





    

        
    
